<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    
    <changeSet id="chicoreus:1 xml" author="paul morris">
        <createTable tableName="unit">
            <column name="unit_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="field_number" 			type="varchar(255)"/>
            <column name="material_sample_id" 			type="bigint"/>
            <column name="verbatim_collection_description" 	type="text"/>
            <column name="collecting_event_id" 			type="bigint"/>
            <column name="unit_remarks" 			type="text"/>
        </createTable>
    </changeSet>
    <changeSet id="chicoreus:2 xml" author="paul morris">
        <createTable tableName="identifiable_item">
            <column name="identifiable_item_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="occurrenceId" 		type="varchar(900)"/>
            <column name="unit_id" 			type="bigint">
		<constraints nullable="false"/>
	    </column>
            <column name="preparation_id" 		type="bigint">
		<constraints nullable="false"/>
	    </column>
            <column name="cataloged_item_id" 		type="bigint"/>
            <column name="individual_count" 		type="int"/>
 	    <column name="individual_count_modifier" 	type="varchar(50)"/>
	    <column name="individual_count_units" 	type="varchar(50)"/>
        </createTable>
    </changeSet>
    <changeSet id="chicoreus:3 xml" author="paul morris">
        <createTable tableName="preparation">
            <column name="preparation_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cataloged_item_id" 		type="bigint"/>
            <column name="material_sample_id" 		type="bigint"/>
            <column name="preparation_type" 		type="varchar(50)"/>
            <column name="preservation_type" 		type="varchar(50)"/>
            <column name="conservation_status" 		type="varchar(255)"/>
 	    <column name="parent_preparation_id" 	type="bigint"/>
	    <column name="remarks" 			type="text"/>
        </createTable>
    </changeSet>

<!-- alter table preparation add constraint fk_parentprep foreign key (parent_preparation_id) references preparation (preparation_id) on update cascade;  -->
    <changeSet id="chicoreus:3.5 xml"   author="paul morris">
	<addForeignKeyConstraint  	baseTableName="preparation" baseColumnNames="parent_preparation_id" 					
					constraintName="fk_parentprep" onUpdate="CASCADE"
					referencedColumnNames="preparation_id"
				        referencedTableName="preparation"/>
    </changeSet>

<!-- alter table identifiable_item add constraint fk_colobj foreign key (unit_id) references unit (unit_id) on update cascade; -->
    <changeSet id="chicoreus:4.0 xml"   author="paul morris">
	<addForeignKeyConstraint  	baseTableName="identifiable_item" baseColumnNames="unit_id" 
					constraintName="fk_colobj" onUpdate="CASCADE"					
					referencedTableName="unit" referencedColumnNames="unit_id"
				        />

    </changeSet>
<!-- alter table identifiable_item add constraint fk_prep foreign key (preparation_id) references preparation (preparation_id) on update cascade; -->
   <changeSet id="chicoreus:4.1 xml" author="paul morris">
	<addForeignKeyConstraint  	baseTableName="identifiable_item" baseColumnNames="preparation_id" 				
					constraintName="fk_prep" onUpdate="CASCADE"					
					referencedTableName="preparation" referencedColumnNames="preparation_id"
				        />
    </changeSet>

    <changeSet id="chicoreus:5 xml" author="paul morris">
        <createTable tableName="identification">
            <column name="identification_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="identifiable_item_id" 		type="bigint"/>
            <column name="taxon_id" 				type="bigint"/>
            <column name="determiner_agent_id" 			type="bigint"/>
            <column name="date_determined_event_date_id" 	type="bigint"/>
            <column name="type_status" 				type="varchar(50)"/>
 	    <column name="verifier" 				type="bigint"/>
	    <column name="date_verified_event_date_id" 		type="bigint"/>
	    <column name="verbatim_annotation_text" 		type="text"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:6 xml" author="paul morris">
        <createTable tableName="taxon">
            <column name="taxon_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="scientificName" 		type="varchar(900)"/>
            <column name="authorship" 			type="varchar(900)"/>
            <column name="parent_taxon_id" 		type="bigint"/>
            <column name="rankid" 			type="int"/>
            <column name="status" 			type="varchar(50)"/>
 	    <column name="accepted_taxon_id" 		type="bigint"/> 
	    <column name="nomenclator_guid" 		type="varchar(900)"/>
	    <column name="curated" 			type="boolean" defaultValueBoolean="false" /> 
	    <column name="author_agent_id" 		type="bigint"/>
	    <column name="parauthor_agent_id" 		type="bigint"/>
	    <column name="exauthor_agent_id" 		type="bigint"/>
	    <column name="parexauthor_agent_id" 	type="bigint"/>
	    <column name="sanctauthor_agent_id" 	type="bigint"/>
	    <column name="parsanctauthor_agent_id" 	type="bigint"/>
	    <column name="cited_in_agent_id" 		type="bigint"/>
	    <column name="publication_id" 		type="bigint"/>
	    <column name="remarks" 			type="text"/>
        </createTable>
    </changeSet>

 <changeSet id="chicoreus:7.0 xml"   author="paul morris">
	<addForeignKeyConstraint  	baseTableName="identification" baseColumnNames="taxon_id" 				
					constraintName="fk_idtaxon" onUpdate="CASCADE"					
					referencedTableName="taxon" referencedColumnNames="taxon_id"
				        />
    </changeSet>

    <changeSet id="chicoreus:7.1 xml"   author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="parent_taxon_id" 				
					constraintName="fk_idparent" onUpdate="CASCADE"					
					referencedTableName="taxon" referencedColumnNames="taxon_id"
				        />
    </changeSet>

    <changeSet id="chicoreus:7.2 xml"   author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="accepted_taxon_id" 				
					constraintName="fk_idaccepted" onUpdate="CASCADE"					
					referencedTableName="taxon" referencedColumnNames="taxon_id"
				        />
    </changeSet>

    <changeSet id="chicoreus:8 xml" author="paul morris">
        <createTable tableName="cataloged_item">
            <column name="cataloged_item_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="catalog_number_series_id" 	type="bigint"/>
            <column name="catalog_number" 		type="varchar(255)"/>
            <column name="date_cataloged_event_date_id" type="bigint"/>
  	    <column name="cataloger_agent_id" 		type="bigint"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:9 xml" author="paul morris">
        <createTable tableName="material_sample">
            <column name="material_sample_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="guid" 			type="varchar(255)"/>
            <column name="sample_number" 		type="varchar(255)"/>
            <column name="date_sampled_event_date_id" 	type="bigint"/>
  	    <column name="sampled_by_agent_id" 		type="bigint"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:10 xml" author="paul morris">
        <createTable tableName="catalog_number_series">
            <column name="catalog_number_series_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" 		type="varchar(900)"/>
            <column name="institution" 		type="varchar(900)"/>
            <column name="institution_code" 	type="varchar(900)"/>
  	    <column name="collection" 		type="varchar(900)"/>
	    <column name="collection_code" 	type="varchar(900)"/>
	    <column name="dataset" 		type="varchar(900)"/>
	    <column name="dataset_id" 		type="varchar(900)"/>
	    <column name="remarks" 		type="TEXT"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:11 xml" author="paul morris">
        <createTable tableName="collecting_event">
            <column name="collecting_event_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="datecollected_event_date_id" 	type="bigint"/>
            <column name="collector_number" 		type="varchar(255)"/>
            <column name="locality_id" 			type="bigint"/>
  	    <column name="collecting_method" 		type="varchar(255)"/>
        </createTable>
    </changeSet>

     <!-- alter table unit add constraint fk_colevent foreign key (collecting_event_id) references collecting_event (collecting_event_id) on update cascade; -->
     <changeSet id="chicoreus:12.0 xml" author="paul morris">
	<addForeignKeyConstraint  	baseTableName="unit" baseColumnNames="collecting_event_id" 				
					constraintName="fk_colevent" onUpdate="CASCADE"					
					referencedTableName="collecting_event" referencedColumnNames="collecting_event_id"
				        />
    </changeSet>

     <changeSet id="chicoreus:13 xml" author="paul morris">
        <createTable tableName="event_date">
            <column name="event_date_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="verbatim_date" 		type="varchar(255)"/>
            <column name="iso_date" 			type="varchar(255)"/>
  	    <column name="start_date" 			type="date"/>
	    <column name="start_date_precision" 	type="int"/>
	    <column name="end_date" 			type="date"/>
	    <column name="end_date_precision" 		type="int"/>
	    <column name="start_end_fully_specifies" 	type="boolean" defaultValueBoolean="true"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:14 xml" author="paul morris">
        <createTable tableName="locality">
            <column name="locality_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="verbatim_locality" 	type="varchar(900)"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:15.0 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="collecting_event" baseColumnNames="locality_id" 				
					constraintName="fk_locality" onUpdate="CASCADE"					
					referencedTableName="locality" referencedColumnNames="locality_id"
				        />
    </changeSet>

    <changeSet id="chicoreus:16 xml" author="paul morris">
        <createTable tableName="other_number">
            <column name="other_number_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="targettable" 		type="varchar(255)"/>
            <column name="pk" 			type="bigint"/>
  	    <column name="number_type" 		type="varchar(255)"/>
	    <column name="number_value" 	type="varchar(255)"/>	    
        </createTable>
    </changeSet>
	
    <!-- alter table other_number add unique index idx_tablepk on other_number(targettable, pk); -->
    <changeSet id="chicoreus:17 xml" author="paul morris" >
	    <createIndex tableName="other_number" unique="true" indexName="idx_tablepk">
	       <column name="targettable" 		type="varchar(255)"/>
	       <column name="pk" 			type="bigint"/>
	    </createIndex>
    </changeSet>

    <changeSet id="chicoreus:18 xml" author="paul morris">
        <createTable tableName="transaction_item">
            <column name="transaction_item_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="trans_preparation_id" type="bigint"/>
            <column name="item_count" 		type="int"/>
  	    <column name="item_count_modifier" 	type="varchar(50)"/>
	    <column name="item_count_units" 	type="varchar(50)"/>
	    <column name="description" 		type="varchar(900)"/>
	    <column name="item_conditions" 	type="text"/>
	    <column name="disposition" 		type="varchar(50)"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:19 xml" author="paul morris">
        <createTable tableName="col_transaction">
            <column name="col_transaction_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="trans_number" 	type="varchar(50)"/>
            <column name="trans_number_series" 	type="varchar(50)"/>
  	    <column name="trans_type" 		type="varchar(50)"/>
	    <column name="status" 		type="varchar(50)"/>	    
	    <column name="conditions" 		type="text"/>
        </createTable>
    </changeSet>

    <changeSet id="chicoreus:20 xml" author="paul morris">
        <createTable tableName="agent">
            <column name="agent_id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="agent_type" 		type="varchar(50)"/>
            <column name="curated" 		type="boolean" defaultValueBoolean="false"/>
        </createTable>
    </changeSet>
	<!--
delimiter //
create trigger tr_prep_const before update on preparation
for each row 
begin
   IF NEW.parent_preparation_id is not null THEN
      select count(*) into @childcount from preparation where parent_preparation_id = NEW.parent_preparation_id;
      IF  childcount > 0 THEN
rem        update errorCantMakeChildPrep set nofield = nofield;
           SIGNAL SQLSTATE '45001' 
               set MESSAGE_TEXT = 'A preparation which is a child cannot itself have children.';
      END IF;
   END IF;
end;//
create trigger tr_prep_const before insert on preparation
for each row 
begin
   IF NEW.parent_preparation_id is not null THEN
      select count(*) into @childcount from preparation where parent_preparation_id = NEW.parent_preparation_id;
      IF  childcount > 0 THEN
rem        update errorCantMakeChildPrep set nofield = nofield;
           SIGNAL SQLSTATE '45001' 
               set MESSAGE_TEXT = 'A preparation which is a child cannot itself have children.';
      END IF;
   END IF;
end;//
delimiter ;
-->



<!-- alter table cataloged_item add constraint foreign key fk_catagent (cataloger_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.0 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="cataloged_item" baseColumnNames="cataloger_agent_id" 				
					constraintName="fk_catagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>
<!-- alter table taxon add constraint foreign key fk_authagent (author_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.1 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="author_agent_id" 				
					constraintName="fk_authagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>

<!-- alter table taxon add constraint foreign key fk_parauthagent (parauthor_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.2 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="parauthor_agent_id" 				
					constraintName="fk_parauthagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>

<!-- alter table taxon add constraint foreign key fk_parauthagent (parauthor_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.3 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="exauthor_agent_id" 				
					constraintName="fk_exauthagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>

<!-- alter table taxon add constraint foreign key fk_parexauthagent (parexauthor_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.4 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="parexauthor_agent_id" 				
					constraintName="fk_parexauthagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>

<!-- alter table taxon add constraint foreign key fk_sanctauthagent (sanctauthor_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.5 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="sanctauthor_agent_id" 				
					constraintName="fk_sanctauthagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>

<!-- alter table taxon add constraint foreign key fk_parsaauthagent (parsanctauthor_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.6 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="parsanctauthor_agent_id" 				
					constraintName="fk_parsaauthagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>

<!-- alter table taxon add constraint foreign key fk_parsaauthagent (parsanctauthor_agent_id) references agent (agent_id) on update cascade; -->
  <changeSet id="chicoreus:21.7 xml" 	author="paul morris">
	<addForeignKeyConstraint  	baseTableName="taxon" baseColumnNames="cited_in_agent_id" 				
					constraintName="fk_citauthagent" onUpdate="CASCADE"					
					referencedTableName="agent" referencedColumnNames="agent_id"
				        />
    </changeSet>
</databaseChangeLog>
